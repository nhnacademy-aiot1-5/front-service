<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>어드민 페이지</title>
    <!-- 부트스트랩 CSS 파일 -->
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
<div class="page-wrapper" id="main-wrapper" data-layout="vertical" data-navbarbg="skin6"
     data-sidebartype="full" data-sidebar-position="fixed" data-header-position="fixed">
    <!-- Sidebar Start -->
    <th:block th:replace="side-bar :: sidebar"></th:block>
    <!--  Sidebar End -->
    <!--  Main wrapper -->
    <div class="body-wrapper">
        <!--  Header Start -->
        <th:block th:replace="header :: header"></th:block>
        <div class="container-fluid">
            <div>
                <h1>관리자 페이지</h1>
                <br/>
            </div>
            <!--  Header End -->
            <table>
                <tr>
                    <td class="mb-4" style="padding: 10px;">
                        <button class="btn btn-primary"
                                style="font-size: 14px; padding: 10px 20px;"
                                onclick="location.href='/admin/roleup'">
                            게스트 유저 관리
                        </button>
                    </td>
                    <td class="mb-4" style="padding: 10px;">
                        <button class="btn btn-primary"
                                style="font-size: 14px; padding: 10px 20px;"
                                onclick="location.href='/admin/users'">
                            유저 관리
                        </button>
                    </td>
                    <td class="mb-4" style="padding: 10px;">
                        <button class="btn btn-primary"
                                style="font-size: 14px; padding: 10px 20px;"
                                onclick="location.href='/admin/budget'">
                            요금 설정
                        </button>
                    </td>
                    <td class="mb-4" style="padding: 10px;">
                        <button class="btn btn-primary"
                                style="font-size: 14px; padding: 10px 20px;"
                                onclick="location.href='/admin/budgethistory'">
                            요금 변경 내역
                        </button>
                    </td>
                    <td class="mb-4" style="padding: 10px;">
                        <button class="btn btn-primary"
                                style="font-size: 14px; padding: 10px 20px;"
                                onclick="location.href='/admin/organization'">
                            조직 정보 관리
                        </button>
                    </td>
                </tr>
            </table>
            <div class="row">
                <div class="col-8 mb-4">
                    <div class="modal-content">
                        <div class="modal-body">
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h4 class="card-title">조직 이름</h4>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <h2 class="fw-semibold mb-3" th:text="${organization.name}">조직 이름</h2>
                                        <button class="btn btn-primary" id="update-name" onclick="openSetNameModal()">
                                            수정하기
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <p><br>
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h4 class="card-title">조직 코드</h4>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <h2 class="fw-semibold mb-3" th:text="${organization.organizationCode}">조직
                                            코드</h2>
                                        <button class="btn btn-primary" id="update-code" onclick="openSetCodeModal()">
                                            수정하기
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!--조직 이름 모달-->
<div class="modal fade" id="settingNameModal" tabindex="-1" aria-labelledby="settingPriceModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="card mb-3">
                    <div class="card-body">
                        <h4 class="card-title">현재 조직 이름</h4>
                        <h2 class="fw-semibold mb-3"
                            th:text="${organization.name}">현재 조직 이름</h2>
                    </div>
                </div>
                <p><br>
                <form action="/admin/organization-name" th:method="PUT" id="putOrganizationName">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <div class="mb-3">
                        <h4 class="fw-semibold mb-3">변경할 조직 이름</h4>
                        <div class="input-group">
                            <input type="text" class="form-control" id="name" name="name"
                                   aria-describedby="amountAddon">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="submit" class="btn btn-primary" form="putOrganizationName">저장</button>
            </div>
        </div>
    </div>
</div>

<!--조직코드 모달-->
<div class="modal fade" id="settingCodeModal" tabindex="-1" aria-labelledby="settingPriceModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="card mb-3">
                    <div class="card-body">
                        <h4 class="card-title">현재 조직 코드</h4>
                        <h2 class="fw-semibold mb-3"
                            th:text="${organization.organizationCode}">현재 조직 코드</h2>
                    </div>
                </div>
                <p><br>
                <form action="/admin/organization-code" th:method="PUT" id="putOrganizationCode">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <div class="mb-3">
                        <h4 class="fw-semibold mb-3">변경할 조직 코드</h4>
                        <div class="input-group">
                            <input type="text" class="form-control" id="code" name="code"
                                   aria-describedby="amountAddon">
                            <button type="button" class="btn btn-secondary" id="checkButton">중복 체크</button>
                        </div>
                    </div>
                </form>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="submit" class="btn btn-primary" form="putOrganizationCode">저장</button>
            </div>
        </div>
    </div>
</div>
<script>
    function openSetNameModal() {
        var myModal = new bootstrap.Modal(document.getElementById('settingNameModal'), {
            keyboard: false
        });
        myModal.show();
    }

    function openSetCodeModal() {
        var myModal = new bootstrap.Modal(document.getElementById('settingCodeModal'), {
            keyboard: false
        });
        myModal.show();
    }

    document.addEventListener('DOMContentLoaded', function() {
        var isCodeDuplicated; // 중복 체크 결과를 저장할 변수, 초기 상태는 undefined

        document.getElementById('code').addEventListener('input', function() {
            // 코드 입력 필드가 변경될 때마다 중복 체크 결과를 초기화
            isCodeDuplicated = undefined;
        });

        document.getElementById('checkButton').addEventListener('click', function() {
            var code = document.getElementById('code').value; // 입력된 코드 값을 가져옵니다.
            if (code) {
                fetch('/admin/checkcode?code=' + encodeURIComponent(code))
                    .then(response => response.json())
                    .then(data => {
                        isCodeDuplicated = data;
                        if (isCodeDuplicated) {
                            alert("이미 사용 중인 코드입니다.");
                        } else {
                            alert("사용 가능한 코드입니다.");
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert("요청 처리 중 오류가 발생했습니다.");
                    });
            } else {
                alert("코드를 입력하세요.");
            }
        });

        document.getElementById('putOrganizationCode').addEventListener('submit', function(event) {
            if (isCodeDuplicated === undefined) {
                alert("코드 중복 체크를 해주세요.");
                event.preventDefault();
            } else if (isCodeDuplicated) {
                alert("중복된 코드입니다. 다른 코드를 입력해 주세요.");
                event.preventDefault();
            }
        });
    });
</script>

</body>
</html>
