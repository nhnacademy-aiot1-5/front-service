<!doctype html>
<html lang="ko">

    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>ÏïÑÏù¥Ïò§Ìã∞ÌÉÄÏûÑ</title>
        <script src="https://code.jquery.com/jquery-3.7.1.js"
                integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
                crossorigin="anonymous"></script>
        <script src="https://cdn.datatables.net/2.0.3/js/dataTables.js"></script>
        <link rel="stylesheet" href="https://cdn.datatables.net/2.0.3/css/dataTables.dataTables.css"/>
        <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
        <link rel="stylesheet" href="/css/style.css">
    </head>

    <body>
        <div class="page-wrapper" id="main-wrapper" data-layout="vertical" data-navbarbg="skin6"
             data-sidebartype="full" data-sidebar-position="fixed" data-header-position="fixed">
            <th:block th:replace="side-bar :: sidebar"></th:block>
            <div class="body-wrapper">
                <th:block th:replace="header :: header"></th:block>
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-12">
                            <h2 class="ps-0" th:text="${userInfo.name}+'ÎãòÏùò Ï†ÑÎ†•Îüâ'"></h2>
                        </div>
                    </div>

                    <div class="row mb-9" style="padding-left: 12px">
                        <select id="monthSelect" class="form-select fw-semibold w-auto">
                            <option value="1">1 Ïõî</option>
                            <option value="2">2 Ïõî</option>
                            <option value="3">3 Ïõî</option>
                            <option value="4">4 Ïõî</option>
                            <option value="5">5 Ïõî</option>
                            <option value="6">6 Ïõî</option>
                            <option value="7">7 Ïõî</option>
                            <option value="8">8 Ïõî</option>
                            <option value="9">9 Ïõî</option>
                            <option value="10">10 Ïõî</option>
                            <option value="11">11 Ïõî</option>
                            <option value="12">12 Ïõî</option>
                        </select>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-body">
                                    <h5>Ï¢Ö Ìï©</h5>
                                    <h1 id="electricitySlogan">Î∞òÍ∞ëÏäµÎãàÎã§ üå± </h1>
                                    <p id="electricityChange" class="mb-0">Ï°∞Ìöå Ìï† Îã¨ÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-9">
                            <div class="card">
                                <div class="card-body pb-2">
                                    <h4 id="month-graph-title" class="card-title fw-semibold">Ï°∞Ìöå Ìï† Îã¨ÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî</h4>
                                    <div id="chart2"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="text-end">ÏÑ§Ï†ï ÏöîÍ∏à</h6>
                                    <h3 class="mb-0 text-end" th:text="${budget}+'Ïõê'"></h3>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="text-end">ÏÇ¨Ïö© ÏöîÍ∏à</h6>
                                    <h3 class="mb-0 text-end">Ïõê</h3>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="text-end">ÎÇ®ÏùÄ ÏöîÍ∏à</h6>
                                    <h3 class="mb-0 text-primary text-end">Ïõê</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-9">
                            <div class="card">
                                <div class="card-body pb-2">
                                    <h4 class="card-title fw-semibold">ÏµúÍ∑º 12 Í∞úÏõî Ï†ÑÍ∏∞ ÏÇ¨Ïö© ÎÇ¥Ïó≠</h4>
                                    <div id="chart1"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="text-end">ÏÑ§Ï†ï Ï†ÑÎ†•Îüâ</h6>
                                    <h3 class="mb-0 text-end">5,200 kWh</h3>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="text-end">ÏÇ¨Ïö© Ï†ÑÎ†•Îüâ</h6>
                                    <h3 class="mb-0 text-end">200 kWh</h3>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="text-end">ÎÇ®ÏùÄ Ï†ÑÎ†•Îüâ</h6>
                                    <h3 class="mb-0 text-primary text-end">5,000 kWh</h3>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <h4 class="card-title">Ï†ÑÎ†• ÏÇ¨Ïö© ÎÇ¥Ïó≠</h4>
                            <div class="table-responsive">
                                <div id="zero_config_wrapper" class="dataTables_wrapper">
                                    <table id="zero_config"
                                           class="table table-striped table-bordered text-nowrap align-middle dataTable"
                                           aria-describedby="zero_config_info">
                                        <thead>
                                            <tr>
                                                <th class="sorting sorting_asc col-1" tabindex="0"
                                                    aria-controls="zero_config" rowspan="1" colspan="1"
                                                    aria-sort="ascending">
                                                    ÎÇ† Ïßú
                                                </th>
                                                <th class="sorting col-1" tabindex="0"
                                                    aria-controls="zero_config"
                                                    rowspan="1" colspan="1">
                                                    Ïöî Í∏à
                                                </th>
                                                <th class="sorting col-1" tabindex="0"
                                                    aria-controls="zero_config"
                                                    rowspan="1" colspan="1">
                                                    kWh
                                                </th>
                                                <th class="sorting col-1" tabindex="0"
                                                    aria-controls="zero_config"
                                                    rowspan="1" colspan="1">
                                                    Î≥Ä Ìôî
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <!--                                                <th class="sorting sorting_asc col-1" tabindex="0"-->
                                                <!--                                                    aria-controls="zero_config" rowspan="1" colspan="1"-->
                                                <!--                                                    aria-sort="ascending">-->
                                                <!--                                                    Ï¥ù Ìï©-->
                                                <!--                                                </th>-->
                                                <!--                                                <th class="sorting col-1 text-end" tabindex="0"-->
                                                <!--                                                    aria-controls="zero_config"-->
                                                <!--                                                    rowspan="1" colspan="1">-->
                                                <!--                                                </th>-->
                                                <!--                                                <th class="sorting col-1 text-end" tabindex="0"-->
                                                <!--                                                    aria-controls="zero_config"-->
                                                <!--                                                    rowspan="1" colspan="1">-->
                                                <!--                                                </th>-->
                                                <!--                                                <th class="sorting col-1 text-end" tabindex="0"-->
                                                <!--                                                    aria-controls="zero_config"-->
                                                <!--                                                    rowspan="1" colspan="1">-->
                                                <!--                                                </th>-->
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script th:inline="javascript">
            var options = {
                chart: {
                    type: 'line',
                    height: '320'
                },
                series: [{
                    name: 'sales',
                    data: []
                }],
                xaxis: {
                    categories: []
                }
            }

            var chart1 = new ApexCharts(document.getElementById("chart1"), options);
            var chart2 = new ApexCharts(document.getElementById("chart2"), options);

            chart1.render();
            chart2.render();

            const monthlyElectricityDtos = [[${recent12monthElectricities}]];
            const kwhData = monthlyElectricityDtos.map(dto => dto.kwh);
            const dates = monthlyElectricityDtos.map(dto => dto.time);

            chart1.updateOptions({
                series: [{
                    name: 'KWh',
                    data: kwhData
                }],
                xaxis: {
                    categories: dates
                }
            });

            let table = new DataTable('#zero_config', {
                responsive: true
            });

            document.getElementById('monthSelect').addEventListener('change', function () {
                const selectedMonth = this.value;
                const year = new Date().getFullYear();  // ÌòÑÏû¨ Ïó∞ÎèÑÎ•º Í∞ÄÏ†∏Ïò¥
                const monthPadded = selectedMonth.padStart(2, '0');  // ÏõîÏùÑ Îëê ÏûêÎ¶¨ Ïà´ÏûêÎ°ú ÌëúÌòÑ (Ïòà: '02')

                const lastDayOfCurrentMonth = new Date(year, monthPadded, 0).getDate();
                const dateForRequest = `${year}-${monthPadded}-${lastDayOfCurrentMonth}T00:00:00`;

                const lastMonth = monthPadded - 1 < 1 ? 12 : monthPadded - 1;
                const lastYear = lastMonth === 12 ? year - 1 : year;
                const lastMonthPadded = lastMonth.toString().padStart(2, '0');
                const lastDayOfLastMonth = new Date(lastYear, lastMonth, 0).getDate();
                const lastDateForRequest = `${lastYear}-${lastMonthPadded}-${lastDayOfLastMonth}T00:00:00`;
                document.getElementById('month-graph-title').textContent = `${selectedMonth}Ïõî Ï†ÑÍ∏∞ ÏÇ¨Ïö© ÎÇ¥Ïó≠`;

                fetch(`/monthly-electricity/${lastDateForRequest}`)
                    .then(response => response.json())
                    .then(lastMonthData => {
                        fetch(`/monthly-electricity/${dateForRequest}`)
                            .then(response => response.json())
                            .then(currentMonthData => {
                                const lastMonthCharge = lastMonthData.kwh;
                                const currentMonthCharge = currentMonthData.kwh;
                                const changePercent = ((currentMonthCharge - lastMonthCharge) / lastMonthCharge) * 100;
                                document.getElementById('electricityChange').textContent =
                                    `${changePercent.toFixed(1)}% Ï†ÄÎ≤à Îã¨ ÎåÄÎπÑ Ï†ÑÍ∏∞Î£å`;
                                if (changePercent < 0) {
                                    document.getElementById('electricitySlogan').textContent = "ÏßëÏóê ÌîºÏπ¥Ï∏ÑÍ∞Ä ÏûàÏúºÏã†Í∞ÄÏöî? ‚ö°";
                                } else {
                                    document.getElementById('electricitySlogan').textContent = "Ï†ÑÍ∏∞ Ï¢Ä ÏïÑÍª¥ Ïì∞ÏÑ∏Ïöî. üå±";
                                }
                                updateChartData(currentMonthData.dailyElectricityDtos);
                                updateDataTable(currentMonthData.dailyElectricityDtos);
                            })
                            .catch(error => console.error('Error fetching current month data: ', error));
                    })
                    .catch(error => console.error('Error fetching previous month data: ', error));
            });

            function updateChartData(dailyData) {
                const kwhData2 = dailyData.map(dto => dto.kwh);
                const dates2 = dailyData.map(dto => dto.time);

                chart2.updateOptions({
                    series: [{
                        name: 'KWh',
                        data: kwhData2
                    }],
                    xaxis: {
                        categories: dates2
                    }
                });
            }

            function updateDataTable(dailyData) {
                table.clear();
                dailyData.forEach(dto => {
                    table.row.add([
                        dto.time,
                        `${dto.kwh} Ïõê`,
                        `${dto.kwh} kWh`,
                        `+${Math.random().toFixed(2)}%`
                    ]).draw(false); // Î≥ÄÍ≤Ω ÏÇ¨Ìï≠ÏùÑ ÌÖåÏù¥Î∏îÏóê Ï¶âÏãú Î∞òÏòÅÌïòÏßÄ ÏïäÏùå
                });
                table.draw(); // Î™®Îì† Îç∞Ïù¥ÌÑ∞Í∞Ä Ï∂îÍ∞ÄÎêú ÌõÑ ÌÖåÏù¥Î∏îÏùÑ Îã§Ïãú Í∑∏Î¶º
            }
        </script>
    </body>
</html>
