<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>IOTEATIME</title>
        <link rel="stylesheet" href="/css/style.css">
        <link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
        <script src="https://fastly.jsdelivr.net/npm/apexcharts"></script>
        <script src="https://fastly.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    </head>

    <body>
        <!--  Body Wrapper -->
        <div class="page-wrapper" id="main-wrapper" data-layout="vertical" data-navbarbg="skin6" data-sidebartype="full"
             data-sidebar-position="fixed" data-header-position="fixed">
            <!-- Sidebar Start -->
            <th:block th:replace="side-bar :: sidebar"></th:block>
            <!--  Sidebar End -->

            <!--  Main wrapper -->
            <div class="body-wrapper">
                <!--  Header Start -->
                <th:block th:replace="header :: header"></th:block>
                <!--  Header End -->

                <div class="container-fluid">
                    <!--                    <div class="card overflow-hidden">-->
                    <div class="card-body position-relative">
                        <div class="row">
                            <div class="col-lg-8 d-flex align-items-strech">
                                <div class="row">
                                    <div class="card w-100 mb-2">
                                        <div class="card-body">
                                            <div class="d-sm-flex d-block align-items-center justify-content-between mb-9">
                                                <div class="overflow-hidden me-6 ">
                                                    <!--                                                <img src="/images/backgrounds/rocket.png" alt="modernize-img" width="40"-->
                                                    <!--                                                     height="40"-->
                                                    <!--                                                     class="me-1">-->
                                                    <!--                                                <br></br>-->
                                                    <h5 class="fw-semibold mb-0 fs-5">‚ö°Ô∏èÏù¥Î≤à Îã¨ Ï¥ùÌèâ‚ö°Ô∏è</h5>
                                                </div>
                                            </div>
                                            <div class="d-sm-flex d-block align-items-center justify-content-between mb-9">
                                                <h2 class="mt-0 mb-0 fw-semibold fs-8 d-flex align-content-center">Ï†ÑÍ∏∞ Ï¢Ä
                                                    ÏïÑÍª¥Ïì∞ÏÑ∏Ïöî.
                                                    üå±</h2>
                                                <p></p>
                                            </div>
                                            <div class="d-flex align-items-center">
                                                <div class="border-end pe-4 border-muted border-opacity-10">
                                                    <p class="mb-0 text-dark">Ïù¥Î≤à Îã¨ Ï†ÑÍ∏∞ ÏÇ¨Ïö©Îüâ 5,200 kWh
                                                        <i class="bi bi-arrow-up-right-circle-fill"
                                                           style="font-size: 1rem;"></i>
                                                    </p>
                                                </div>
                                                <div class="ps-4">
                                                    <p class="mb-0 text-dark">Ïù¥Î≤à Îã¨ Ï†ÑÍ∏∞Î£å ‚Ç© 2,340
                                                        <i class="bi bi-arrow-up-right-circle-fill"
                                                           style="font-size: 1rem;"></i>
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Ïã§ÏãúÍ∞Ñ ÏÇ¨Ïö©Îüâ Í∑∏ÎûòÌîÑ -->
                                    <div class="card w-100">
                                        <div class="card-body">
                                            <div class="d-sm-flex d-block align-items-center justify-content-between mb-3">
                                                <div class="overflow-hidden me-6">
                                                    <h5 class="fw-semibold">Ïã§ÏãúÍ∞Ñ Ï†ÑÎ†• ÏÇ¨Ïö©Îüâ</h5>
                                                </div>
                                            </div>
                                            <div class="d-sm-flex d-block align-items-center justify-content-between">

                                                <div id="realtime-total"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>



                            </div>
                            <div class="col-lg-4">
                                <!-- ÏöîÍ∏à Í≤åÏù¥ÏßÄ Î∞î -->
                                <div class="col-lg-12">
                                    <div class="card overflow-hidden mb-2">
                                        <div class="card-body p-3">
                                            <h5 class="card-title mb-9 fw-semibold">ÌÖåÏä§Ìä∏ ÏöîÍ∏à</h5>
                                            <div class="row align-items-center">
                                                <div class="col-12">
                                                    <div id="gauge-chart"></div>
                                                    <script th:inline="javascript">
                                                        var billPercentage = [[${budget}]];
                                                        console.log(billPercentage.electricity_budget)
                                                        // Ï∞®Ïï° * 100 / ÏÑ§Ï†ï ÏöîÍ∏à
                                                        var options1 = {
                                                            series: [70],
                                                            chart: {
                                                                height: 200,
                                                                type: 'radialBar',
                                                                toolbar: {
                                                                    show: true
                                                                }
                                                            },
                                                            plotOptions: {
                                                                radialBar: {
                                                                    startAngle: -135,
                                                                    endAngle: 225,
                                                                    hollow: {
                                                                        margin: 0,
                                                                        size: '60%',
                                                                        background: '#fff',
                                                                        image: undefined,
                                                                        imageOffsetX: 0,
                                                                        imageOffsetY: 0,
                                                                        position: 'front',
                                                                        dropShadow: {
                                                                            enabled: true,
                                                                            top: 3,
                                                                            left: 0,
                                                                            blur: 4,
                                                                            opacity: 0.24
                                                                        }
                                                                    },
                                                                    track: {
                                                                        background: '#fff',
                                                                        strokeWidth: '0%',
                                                                        margin: 0, // margin is in pixels
                                                                        dropShadow: {
                                                                            enabled: true,
                                                                            top: 0,
                                                                            left: 0,
                                                                            blur: 4,
                                                                            opacity: 0.35
                                                                        }
                                                                    },

                                                                    dataLabels: {
                                                                        show: true,
                                                                        name: {
                                                                            offsetY: -10,
                                                                            show: true,
                                                                            color: '#888',
                                                                            fontSize: '16px'
                                                                        },
                                                                        value: {
                                                                            formatter: function (val) {
                                                                                return parseInt(val) + '%';
                                                                            },
                                                                            color: '#111',
                                                                            fontSize: '20px',
                                                                            show: true,
                                                                        }
                                                                    }
                                                                }
                                                            },
                                                            fill: {
                                                                type: 'gradient',
                                                                gradient: {
                                                                    shade: 'dark',
                                                                    type: 'horizontal',
                                                                    shadeIntensity: 0.5,
                                                                    gradientToColors: ['#ABE5A1'],
                                                                    inverseColors: true,
                                                                    opacityFrom: 1,
                                                                    opacityTo: 1,
                                                                    stops: [0, 100]
                                                                }
                                                            },
                                                            stroke: {
                                                                lineCap: 'round'
                                                            },
                                                            labels: ['Percent'],
                                                        };

                                                        var chart1 = new ApexCharts(document.querySelector("#gauge-chart"), options1);
                                                        chart1.render();

                                                    </script>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="d-flex justify-content-center">
                                        <!-- ÏÇ¨Ïö© ÏöîÍ∏à -->
                                        <div class="col-lg-4 ">
                                            <div class="card overflow-hidden">
                                                <div class="card-body p-3">
                                                    <h5 class="card-title mb-9 fw-semibold">ÏÇ¨Ïö© ÏöîÍ∏à</h5>
                                                    <div class="row align-items-center">
                                                        <div class="col-20">
                                                            <h2 class="fs-2 fw-semibold mb-3 text-nowrap">‚Ç©
                                                                112,136,358</h2>
                                                            <div class="d-flex align-items-center mb-3">
                                                                <i class="bi bi-arrow-up-left-circle-fill text-success me-1"
                                                                   style="font-size: 0.5rem;"></i>
                                                                <p class="me-1 fs-2 mb-0">+9%</p>
                                                                <p class="fs-1 mb-0">ÏßÄÎÇú Îã¨</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- ÏÑ§Ï†ï ÏöîÍ∏à -->
                                        <div class="col-lg-4" id="update-fee" th:data-role="${userInfo.role}"
                                             onclick="checkRoleAndOpenModal()">
                                            <div class="card overflow-hidden">
                                                <div class="card-body p-3">
                                                    <h5 class="card-title mb-9 fw-semibold">ÏÑ§Ï†ï ÏöîÍ∏à</h5>
                                                    <div class="row align-items-center">
                                                        <div class="col-20">
                                                            <h2 class="fs-2 fw-semibold mb-3 text-nowrap"
                                                                th:text="'‚Ç© '+${#numbers.formatInteger(budget.electricityBudget, 0, 'COMMA')}">
                                                                ÌòÑÏû¨ ÏÑ§Ï†ï ÏöîÍ∏à</h2>
                                                            <div class="d-flex align-items-center mb-3">
                                                                <p class="me-1 fs-2 mb-0">ÌÅ¥Î¶≠ Ïãú</p>
                                                                <p class="fs-2 mb-0">ÏàòÏ†ï</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>


                                        <!-- Ï∞®Ïï° -->
                                        <div class="col-lg-4 ">
                                            <div class="card overflow-hidden">
                                                <div class="card-body p-3">
                                                    <h5 class="card-title mb-9 fw-semibold">ÏöîÍ∏à Ï∞®Ïï°</h5>
                                                    <div class="row align-items-center">
                                                        <div class="col-20">
                                                            <h2 class="fs-2 fw-semibold mb-3 text-nowrap">‚Ç© 136,358</h2>
                                                            <div class="d-flex align-items-center mb-3">
                                                                <i class="bi bi-arrow-up-left-circle-fill text-success me-1"
                                                                   style="font-size: 0.5rem;"></i>
                                                                <p class="me-1 fs-2 mb-0">+9%</p>
                                                                <p class="fs-1 mb-0">ÏßÄÎÇú Îã¨</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--                    </div>-->
                    <!---Ï¥ùÌèâ Î∞ïÏä§ ÎÅù---->


            <div class="row">

                <!-- Í∑∏ÎûòÌîÑ -->
                <div class="col-lg-9 d-flex align-items-strech">
                    <div class="card w-100">
                        <div class="card-body">
                            <div class="d-sm-flex d-block align-items-center justify-content-between mb-9">
                                <div class="mb-3 mb-sm-0">
                                    <h5 class="card-title fw-semibold">Ïã§ÏãúÍ∞Ñ Ï†ÑÎ†•Îüâ</h5>
                                </div>
                            </div>
                            <!-- Ï∞®Ìä∏ -->
                            <div id="realtimeChart"></div>
                        </div>
                    </div>
                </div>

                <!-- ÏÇ¨Ïö© Ï†ÑÎ†•Îüâ -->
                <div class="col-md-3">
                    <div class="row">
                        <div class="card">
                            <div class="card-body">
                                <h5>
                                    Ï†ÑÏõî ÏÇ¨Ïö© Ï†ÑÎ†•Îüâ
                                    <i class="ti ti-bolt fs-6 text-warning"></i>
                                </h5>
                                <h4 th:text="${{lastMonthKwh + ' kwh'}}">5,596.70 kWh</h4>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-body">
                                <h5>
                                    Í∏àÏùº ÏÇ¨Ïö© Ï†ÑÎ†•Îüâ
                                    <i class="ti ti-bolt fs-6 text-warning"></i>
                                </h5>
                                <h4 th:text="${{todayKwh + ' kwh'}}">54.50 kWh</h4>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-body">
                                <h5>
                                    Í∏àÏõî ÏÇ¨Ïö© Ï†ÑÎ†•Îüâ
                                    <i class="ti ti-bolt fs-6 text-warning"></i>
                                </h5>
                                <h4 th:text="${{thisMonthKwh + ' kwh'}}">1,257.60 kWh</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!--Î™®Îã¨-->
<div class="modal fade" id="settingPriceModal" tabindex="-1" aria-labelledby="settingPriceModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">ÌòÑÏû¨ ÏÑ§Ï†ï ÏöîÍ∏à</h5>
                        <h4 class="fw-semibold mb-3"
                            th:text="'‚Ç© '+${#numbers.formatInteger(budget.electricityBudget, 0, 'COMMA')}">ÌòÑÏû¨ ÏÑ§Ï†ï ÏöîÍ∏à</h4>
                    </div>
                </div>
                <p><br>
                <form th:action="@{/budget}" th:method="PUT" id="resetTargetAmountForm">
                    <div class="mb-3">
                        <h4 class="fw-semibold mb-3">Î™©Ìëú ÏöîÍ∏à Ïû¨ÏÑ§Ï†ï</h4>
                        <div class="input-group" style="width: 70%;">
                            <input type="number" class="form-control" id="budget" name="budget"
                                   aria-describedby="amountAddon">
                            <span class="input-group-text" id="amountAddon">Ïõê</span>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Îã´Í∏∞</button>
                <button type="submit" class="btn btn-primary" form="resetTargetAmountForm">Ï†ÄÏû•</button>
            </div>
        </div>
    </div>
</div>
<script>
    let options = {
        chart: {
            type: 'bar',
            height:250
        },
        plotOptions: {
            bar: {
                horizontal: true,
            },
        },
        series: [
            {
                name: 'Electricity',
                data: [],
            },
        ],
        xaxis: {
            categories: [],
        },
        title: {
            text: 'Ïã§ÏãúÍ∞Ñ Ï†ÑÎ†•Îüâ Top 10',
            align: 'center',
        },
    };

    let chart = new ApexCharts(document.querySelector('#realtimeChart'), options);

    chart.render();

    function fetchDataAndUpdateChart() {
        fetch('/top10')
            .then((response) => response.json())
            .then((data) => {
                chart.updateSeries([
                    {
                        name: 'Electricity',
                        data: data.map((item) => item.w),
                    },
                ]);

                chart.updateOptions({
                    xaxis: {
                        categories: data.map((item) => `${item.place}\n${item.channel}`),
                    },
                });
            });
    }

    fetchDataAndUpdateChart();

    setInterval(fetchDataAndUpdateChart, 60000);
</script>

<script>
    function checkRoleAndOpenModal() {
        var updateFeeDiv = document.getElementById('update-fee');
        var role = updateFeeDiv.getAttribute('data-role');
        if (role === 'ADMIN') {
            openSetBudgetModal();
        }
    }

    function openSetBudgetModal() {
        var myModal = new bootstrap.Modal(document.getElementById('settingPriceModal'), {
            keyboard: false
        });
        myModal.show();
    }
</script>


    <script>

        var realtimeTotalOptions = {
            series: [{
                name: "kwh",
                data: []
            }],
            chart: {
                id: 'realtime',
                height: 350,
                type: 'bar',
                zoom: {
                    enabled: false
                },
                animations: {
                    enabled: true,
                    easing: 'linear',
                    dynamicAnimation: {
                        speed: 1000
                    }
                }
            },
            dataLabels: {
                enabled: false
            },
            title: {
                text: '5Î∂ÑÍ∞Ñ Ï¥ù ÏÜåÎπÑÎüâ',
                align: 'left'
            },
            grid: {
                row: {
                    colors: ['#f3f3f3'],
                    opacity: 0.5
                },
            },
            xaxis: {
                type: 'datetime',
                tickAmount: 12,
                labels: {
                    format: 'HH:mm'
                }
            },
            yaxis: {
                tickAmount: 4,
                labels: {
                    formatter: function (val) {
                        return val.toFixed(1);
                    }
                }
            },
            tooltip: {
                x: {
                    format: 'HH:mm'
                }
            }
        };

        var realtimeTotalChart = new ApexCharts(document.querySelector("#realtime-total"), realtimeTotalOptions);
        realtimeTotalChart.render();

        function fetchOneHourTotalData() {
            fetch('/total?organizationId=1')
                .then(response => response.json())
                .then(data => {
                    if (!Array.isArray(data)) {
                        console.error('Expected an array of data but got:', data);
                        return;
                    }
                    var seriesData = data.map(item => {
                        const dateArray = item.time;
                        const year = dateArray[0];
                        const month = dateArray[1] - 1;
                        const day = dateArray[2];
                        const hour = dateArray[3];
                        const minute = dateArray[4];
                        const second = dateArray[5];

                        const time = new Date(Date.UTC(year, month, day, hour, minute, second));

                        return {
                            x: time.getTime(),
                            y: item.kwh
                        };
                    });

                    seriesData.sort((a, b) => a.x - b.x);
                    realtimeTotalChart.updateSeries([{
                        data: seriesData
                    }]);
                })
                .catch(error => console.error('Error fetching data:', error));
        }

        document.addEventListener('DOMContentLoaded', function() {
            fetchOneHourTotalData();
            setInterval(fetchOneHourTotalData, 300000);
        });

    </script>
</body>

</html>
